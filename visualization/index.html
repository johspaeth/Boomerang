<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>jQuery.getJSON demo</title>
  <link rel="stylesheet" href="style.css">
  <link rel="stylesheet" href="webix/codebase/webix.css">
  <script src="data.js"></script>
  <script src="libs/jquery-3.1.1.min.js"></script>
  <script src="libs/cytoscape.js"></script>
  <script src="webix/codebase/webix.js"></script>
  <script src="libs/dagre.min.js"></script>
  <script src="libs/cytoscape-dagre.js"></script>


</head>
<body>
<script>
var selectedDirection ="BACKWARD";
var isShortNotation = true;
var highlightedNode;
webix.ui({
  view: "tabview",
  cells: [
  
    {
      header: "Boomerang Visualization",
      body: {
        cols:[{view: "list", 
              data: methodList,
              width: 300,
              template: "<span style='font-size:9pt'>#name#</span>",
              select:true,
              on:{
                 onSelectChange:function (selection) {
                  activeMethod = selection[0]
                    renderMethodWithESG(activeMethod,$("div[id=methodGraph]"));
                 }
              }
            },
            { view:"resizer" },
              {rows:[{view:"toolbar",
                      id:"myToolbar",
                      cols:[
                          { view:"segmented", width: 270,
                            align: "center",
                            on:{
                              onChange: function(selection){
                                selectedDirection = selection;
                                renderMethodWithESG(activeMethod,$("div[id=methodGraph]"));
                              }
                            }, 
                            
                            options:[
                            {id:"BACKWARD", value:"Backward"},
                            {id:"FORWARD", value:"Forward"},
                            ] 
                          },
                          { 
                              view:"label", 
                              id: "methodLabel",
                              label: "Label", 
                              align:"center"
                          }
                          ]},{
                view:"template",
                template: "<div id='methodGraph' style='height: 100%;'></div>",
                on:{
                  onAfterRender:function(){
                    renderMethodWithESG(activeMethod,$("div[id=methodGraph]"));
                  }
                },
                minHeight: 200,
                }]}
        ]
      
      }
    }
  ]});

function isReverseEdge(el){
  if(el.data().direction == "FORWARD"){
    return el.source().position().y > el.target().position().y;
  } else{
    return el.source().position().y < el.target().position().y;
  }
}
function drawStraighLine(el){
  return el.source().data().stmtIndex +1 == el.target().data().stmtIndex;
}
function isIdentityEdge(el){
    return el.source().position().x == el.target().position().x;
}

function addClassWhileOver(overElement,elements,cls){
  elements.addClass(cls);
  overElement.once('mouseout', function(event){
      elements.removeClass(cls);
  })
}

function renderMethodIn(methodId, methodDiv){
  var cy = null;
  $.each( methods, function( i, item ) {
        if(item.methodId != methodId)
          return;

        $$("methodLabel").setValue(item.methodName);
        $$("methodLabel").refresh();
        cy = cytoscape({
          container: methodDiv,
          zoomingEnabled: true,
          userZoomingEnabled: true,
          panningEnabled: true,
          userPanningEnabled: true,
          layout: {
            name: 'preset'
          },

          style: [
            {
              selector: 'node',
              style: {
                'height': 6,
                'width':6,
                'background-color': '#cccccc',
              }
            },
          {
              selector: '.stmt.label',
              style: {
                'background-color': '#cccccc',
                'label': (isShortNotation ? 'data(shortLabel)' : 'data(label)'),
                'text-halign': 'right',
                'font-size': '12pt',
                'color': '#666',
                'height': 10,
                'width':10,
                'font-family': 'Courier'
              }
            }, {
              selector: '.stmt.label.callSite',
              style: {
                'background-color': 'green'
              }
            }, {
              selector: '.stmt.label.returnSite',
              style: {
                'background-color': 'red'
              }
            }, 
            {
              selector: '.fact.label',
              style: {
                'label': 'data(label)',
                'background-color': '#ffffff',
                'text-rotation': '90deg',
                'text-halign': 'left',
                'font-size': '12pt',
                'color': '#666',
                'font-family': 'Courier'
              }, },
            {
              selector: '.label.bold',
              style: {
                "font-weight": "bold",
                'color': '#111',
              }
            },

            {
              selector: '.label.boldHighlight',
              style: {
                "font-weight": "bold",
                'color': 'rgb(255, 156, 49)',
              }
            },{
              selector: '.cfgEdge',
              style: {
                'target-arrow-shape': 'triangle',
                'target-arrow-color': '#ccc',
                'line-color': '#ccc',
                'width': 1,
               
                'curve-style': function(el){return (drawStraighLine(el) ? 'bezier': 'unbundled-bezier');}
              }
            },
            {
              selector: '.esgEdge',
              style: {
                'target-arrow-shape': 'triangle',
                'target-arrow-color': function(el){ return (isIdentityEdge(el) ? '#cccccc' : 'blue');},
                'width': 1,
                'line-color': function(el){ return (isIdentityEdge(el) ? "#cccccc" : 'blue');},
                
                'curve-style': function(el){return (isReverseEdge(el) ? 'unbundled-bezier': 'bezier');}
              }
            },{
              selector: '.hidden',
              style: {
                'opacity': '0'
              }
            },{
              selector: '.callFlow',
              style: {
                'target-arrow-color': 'green',
                'line-color': 'green',
                'target-arrow-shape': 'none',
                'line-style': 'dotted',
              }
            },{
              selector: '.summaryFlow',
              style: {
                'target-arrow-color': 'green',
                'line-color': 'green',
              }
            },{
              selector: '.returnFlow',
              style: {
                'target-arrow-color': 'green',
                'line-color': 'green',
                'target-arrow-shape': 'none',
                'line-style': 'dotted',
              }
            },{
              selector: '.call2ReturnFlow',
              style: {
              }
            },{
              selector: '.indirectReadFlow',
              style: {
                'target-arrow-color': 'green',
                'line-color': 'green',
                'line-style': 'dashed',
              }
            },{
              selector: '.indirectCallFlow',
              style: {
                'target-arrow-color': 'green',
                'line-color': 'green',
                'line-style': 'dashed',
              }
            },{
              selector: '.indirectReturnFlow',
              style: {
                'target-arrow-color': 'green',
                'line-color': 'green',
                'line-style': 'dashed',
              }
            },{
              selector: '.highlight',
              style: {
                'height': 8,
                'width':8,
                'opacity': '1',
                'background-color': 'orange'
              }
            },{
              selector: '.indirectWriteFlow',
              style: {
                'target-arrow-color': 'green',
                'line-color': 'green',
                'line-style': 'dashed',
              }
            }
          ],

          elements: item.data});
  });
  return cy;
}
function renderMethodWithESG(methodId, methodDiv){

        var cy = renderMethodIn(methodId,methodDiv);
        if(cy == null)
          return;
          cy.$("*").addClass("hidden");
          cy.$(".label").removeClass("hidden");
          cy.$(".method"+methodId+"."+selectedDirection).removeClass("hidden");
          
          cy.on('mouseover','node[callSite]',function(event){
            var el = webix.ui({
                view:"contextmenu",
                id: "callSiteContextMenu", 
                width: 500,
                template: "#name#",
                on:{
                  onItemClick: function(el){
                    activeMethod = el;
                    renderMethodWithESG(el,$("div[id=methodGraph]"));
                  }
                },
                data:event.cyTarget.data().callees}).show();

            $$("callSiteContextMenu").setPosition(event.originalEvent.x,event.originalEvent.y);
            event.cyTarget.once('mouseout', function(event){
                $$("callSiteContextMenu").hide();
            })

          });
          cy.on('mouseover','node[returnSite]',function(event){
            var el = webix.ui({
                view:"contextmenu",
                id: "callSiteContextMenu", 
                width: 500,
                template: "#name#",
                on:{
                  onItemClick: function(el){
                    activeMethod = el;
                    renderMethodWithESG(el,$("div[id=methodGraph]"));
                  }
                },
                data:event.cyTarget.data().callers}).show();

            $$("callSiteContextMenu").setPosition(event.originalEvent.x,event.originalEvent.y);
            event.cyTarget.once('mouseout', function(event){
                $$("callSiteContextMenu").hide();
            })

          });
          cy.on('mouseover', 'node', function(event) {
            var tgt = event.cyTarget;
              if(tgt.hasClass("hidden"))
                return;
              if(!tgt.hasClass("queryNode"))
                return;
            var queryId = tgt.data().queryId;
            var elements = cy.elements("node[queryId="+queryId+"]");
           
            addClassWhileOver(tgt,elements,"hightlight");
          });
           cy.on('mouseover', 'node.esgNode', function(event) {
            var tgt = event.cyTarget;
              if(tgt.hasClass("hidden"))
                return;
              global = tgt;
              cy.elements().breadthFirstSearch( {
                root: tgt,
                directed: true, 
                visit: function(i, depth, v){
                  addClassWhileOver(tgt,v,"highlight")
              }
            });
            var stmtId = tgt.data().stmtId;
            var elements = cy.$("node[stmtId="+stmtId+"]");
            addClassWhileOver(tgt,elements,"bold");

            var factId = tgt.data().factId;
            var elements = cy.$("node[factId="+factId+"]");
            addClassWhileOver(tgt,elements,"bold");
          });
           return cy;
};
</script>
 
</body>
</html>